import pygame
import sys
from random import randint
import os

pygame.init()
L = 1280
H = 720
screen = pygame.display.set_mode((L, H))
clock = pygame.time.Clock()


class Goutte:
    def __init__(self, x, y, vitesse, longueur):
        self.x = x
        self.y = y
        self.vitesse = vitesse
        self.longueur = longueur

    def dessine(self):
        pygame.draw.line(screen, (135, 206, 235), (self.x, self.y), (self.x, self.y + self.longueur), 2)

    def tombe(self):
        self.y += self.vitesse
        if self.y > H:
            self.y = randint(-20, 0)
            self.x = randint(0, L)

class escargot:
    def __init__(self, img, img2, y=680):
        self.x = 0
        self.y = y
        self.vitesse = 10
        self.img = img
        self.img2 = img2

    def bouger(self):
        self.vitesse += 0.1
        self.x += self.vitesse

    def afficher(self):
        screen.blit(self.img, (self.x, self.y))
        
class Fond:
    def bouger(self):
        pass
    def afficher(self):
        screen.blit(bg, (0, 0))


class affiche_victoire():
    def __init__(self, couleur):
        self.couleur = couleur
        self.font = pygame.font.SysFont(None, 72)
        self.texte = self.font.render(f"Victoire de {self.couleur} !", True, (255, 255, 255))
        
    def afficher(self):
        screen.blit(self.texte, (L//2 - self.texte.get_width()//2, H//2 - self.texte.get_height()//2))
    
    def bouger(self):
        pass
    
# class Lanceur():
#     def __init__(self):
#         self.font = pygame.font.SysFont(None, 72)
#         self.texte = self.font.render(f"", True, (255,255,255))

bg = pygame.transform.scale(pygame.image.load(os.path.join("images","background.png")), (1280, 720))
bleu = pygame.transform.scale(pygame.image.load(os.path.join("images","snail_1.1.png")), (110, 110))
bleu2 = pygame.transform.scale(pygame.image.load(os.path.join("images","snail_1.2.png")), (110, 110))
vert = pygame.transform.scale(pygame.image.load(os.path.join("images","snail_2.1.png")), (110, 110))
vert2 = pygame.transform.scale(pygame.image.load(os.path.join("images","snail_2.2.png")), (110, 110))
jaune = pygame.transform.scale(pygame.image.load(os.path.join("images","snail_3.1.png")), (120, 120))
jaune2 = pygame.transform.scale(pygame.image.load(os.path.join("images","snail_3.2.png")), (120, 120))
violet = pygame.transform.scale(pygame.image.load(os.path.join("images","snail_4.1.png")), (110, 110))
violet2 = pygame.transform.scale(pygame.image.load(os.path.join("images","snail_4.2.png")), (110, 110))


# Initialisation des gouttes de pluie
gouttes = []
for _ in range(100):
    x = randint(0, L)
    y = randint(-H, 0)
    vitesse = randint(5, 15)
    longueur = randint(5, 15)
    gouttes.append(Goutte(x, y, vitesse, longueur))
    
# LISTE DE TOUTES LES CLASSES EN ORDRE DE COUCHE
liste_objets = [Fond()]
listeescargots = [
    escargot(img=bleu, img2=bleu2, y=460),
    escargot(img=vert, img2=vert2, y=520),
    escargot(img=jaune, img2=jaune2, y=570),
    escargot(img=violet, img2=violet2,  y=620),
]

# Boucle principale
run = True
compteur_pluie = 0
pluie_active = False
prev_keys = pygame.key.get_pressed()
victoire = None

while run:
    for evenement in pygame.event.get():
        if evenement.type == pygame.QUIT:
            run = False

    clock.tick(60)  # NOMBRE D'IMAGES PAR SECONDE
    screen.fill("black") # RAFRAICHISSEMENT DE L'ÉCRAN

    keys = pygame.key.get_pressed()
    if keys[pygame.K_RIGHT] and not prev_keys[pygame.K_RIGHT]:
        listeescargots[0].bouger()
    if keys[pygame.K_LCTRL] and not prev_keys[pygame.K_LCTRL]:
        listeescargots[1].bouger()
    if keys[pygame.K_SPACE] and not prev_keys[pygame.K_SPACE]:
        listeescargots[2].bouger()
    if keys[pygame.K_RCTRL] and not prev_keys[pygame.K_RCTRL]:
        listeescargots[3].bouger()
        
    if keys[pygame.K_TAB] and not prev_keys[pygame.K_TAB]:
        for escargot in listeescargots:
            escargot.x = 0
        victoire = None
        
    prev_keys = keys
    
    # Dessine et déplace les gouttes si la pluie est active
    if pluie_active:
         for goutte in gouttes:
             goutte.dessine()
             goutte.tombe()
    
    # Incrémente le compteur de pluie
    compteur_pluie += 1
    # Active la pluie après 300 frames
    if compteur_pluie >= 800 and not pluie_active:
        pluie_active = True

    # Si la pluie est active, incrémente le compteur de durée
    if pluie_active:
        compteur_pluie += 1
        if compteur_pluie >= 1700 and pluie_active:
            pluie_active = False
            compteur_pluie = 0

    #APPELS AUX OBJETS DANS CHAQUE CLASSE DANS LA LISTE
    for obj in liste_objets:
        obj.afficher()
        obj.bouger() 
    for escargot in listeescargots:
        escargot.afficher()
    for i, escargot in enumerate(listeescargots):
        if escargot.x >= L - 30 and victoire is None:  # Si l'escargot arrive à droite de l'écran
            victoire = affiche_victoire(['bleu', 'vert', 'jaune', 'violet'][i])
    if victoire:
        victoire.afficher()

    pygame.display.flip()
pygame.quit()
sys.exit()
